---
title: "Java Memory Leak for JDBC"
layout: default
tags: [java, jdbc, memory leak, garbage collector]
comments: true
categories: development
date: 2019-06-03 15:46:08 +0300
published: 2019-06-03 15:46:08 +0300
---

<h1> The Context</h1>

<p>I had written an engine using a custom ClassLoader. To do that just create a new <a
        href="https://docs.oracle.com/javase/7/docs/api/java/net/URLClassLoader.html">URLClassLoader</a>, load a jar and
    execute what code you want, than close the URLClassLoader. If the new ClassLoader doesn't have access to the current
    ClassLoader, the loaded classes does not have access to your code. Good! Very Good!</p>


<script src="https://gist.github.com/vepo/492f8cdc4f99ff56173177a0541c93d0.js"></script>

<h1>The Problem </h1>

<p>But... We do not have control with the code loaded from an external Jar. That is the problem. So if you want to avoid
    memory leaks the your custom classloader should be released by Garbage Collector. If the loaded code uses JDBC you
    will soon get an OutOfMemoryError and everything will crash! Not good!</p>

<h1>The reason</h1>
<p>Whe JDBC loads the driver they assumes that you will use only one ClassLoader, so it create a reference to your
    ClassLoader. This reference prevents the Garbage Collector from removing your custom ClassLoader from the memory.
</p>

<img src="https://thepracticaldev.s3.amazonaws.com/i/789mmfr2dkp8ezgm2p91.png" />

<p>So, even if you create your ClassLoader, execute your code and close it. The total of loaded classes will never
    decrease.</p>

<h1>How to solve?</h1>

<p>To solve this problem we have to unregister all JDBC drivers just after the execution, than close URLClassLoader.</p>

<script src="https://gist.github.com/vepo/1ba27d72ab93177677c927fe8b11daf5.js"></script>

<p>Now, let's look for the loaded classes:</p>

<img src="https://thepracticaldev.s3.amazonaws.com/i/xzaa7ftdokc0078tg9n5.png" />

<h1>Possible problems</h1>

<ol>
    <li>If the executed code create any Thread, the URLClassLoader is not eligible for Garbage Collector.</li>
    <li>If some library create any Thread, same problem from #1.</li>
    <li>MongoDb client create a Thread. ðŸ˜«</li>
</ol>